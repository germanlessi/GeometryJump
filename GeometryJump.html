<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>2D Parkour Spiel (WASD & Levelauswahl)</title>
    
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            font-family: 'Arial', sans-serif;
            color: white;
        }

        #gameCanvas {
            border: 5px solid #ecf0f1;
            background-color: #3498db;
            cursor: pointer;
        }

        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            font-size: 1.2em;
            color: white;
            text-shadow: 1px 1px 1px black;
        }
    </style>
</head>
<body>
    
    <div id="info">
        Level: <span id="level-display"></span> | Steuerung: **WASD** bewegen, **Leertaste** springen.
    </div>

    <canvas id="gameCanvas" width="800" height="400"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Globale Variablen ---
        let gameLoopId;
        let gameState = 'menu'; // NEU: 'menu', 'running', 'complete', 'gameover'
        let currentLevel = 1; // Das Level, das gerade gespielt wird
        let maxUnlockedLevel = 1; // NEU: Das h√∂chste freigeschaltete Level
        const totalLevels = 5;

        // --- SPIELER-OBJEKT (unver√§ndert) ---
        let player = {
            x: 50,
            y: 0,
            width: 30,
            height: 30,
            color: '#e74c3c',
            velocityY: 0,
            speedX: 0,
            isJumping: false,
            onGround: false
        };

        // --- PHYSIK & KONSTANTEN (unver√§ndert) ---
        const GRAVITY = 0.5;
        const JUMP_VELOCITY = -12;
        const PLAYER_SPEED = 4;
        const FRICTION = 0.8; 
        let platforms = [];
        let keys = {};

        // --- KONSTANTEN F√úR LEVELS (unver√§ndert) ---
        const LEVEL_CONFIG = {
            1: { count: 6, minGap: 80, maxGap: 150, minY: 250, maxY: 350, color: '#2ecc71' },
            2: { count: 8, minGap: 60, maxGap: 120, minY: 200, maxY: 350, color: '#f1c40f' },
            3: { count: 10, minGap: 50, maxGap: 100, minY: 200, maxY: 380, color: '#e67e22' },
            4: { count: 12, minGap: 40, maxGap: 90, minY: 200, maxY: 380, color: '#c0392b' },
            5: { count: 15, minGap: 30, maxGap: 80, minY: 200, maxY: 380, color: '#9b59b6' }
        };

        // --- HINDERNIS-GENERIERUNG (unver√§ndert) ---
        function generateLevel(level) {
            platforms = [];
            const config = LEVEL_CONFIG[level];
            const platformHeight = 20;
            const groundY = canvas.height - 50;

            let currentX = 0;
            let currentY = groundY - 30;

            platforms.push({ x: 0, y: groundY, width: 100, height: 50, color: config.color, isGoal: false });

            for (let i = 0; i < config.count; i++) {
                const gap = Math.floor(Math.random() * (config.maxGap - config.minGap)) + config.minGap;
                const newY = Math.floor(Math.random() * (config.maxY - config.minY)) + config.minY;
                const platformWidth = Math.random() * 50 + 70;

                currentX += gap;
                currentY = newY; 

                platforms.push({ x: currentX, y: currentY, width: platformWidth, height: platformHeight, color: config.color, isGoal: false });
                currentX += platformWidth;
            }

            platforms.push({ x: currentX + 150, y: groundY - 50, width: 150, height: 100, color: '#34495e', isGoal: true });
            
            player.x = platforms[0].x + 10;
            player.y = platforms[0].y - player.height;
            player.velocityY = 0;
            player.speedX = 0;
            player.isJumping = false;
            player.onGround = true;

            document.getElementById('level-display').textContent = level;
        }

        // --- STEUERUNG (unver√§ndert) ---
        function setupControls() {
            document.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                if (e.code === 'Space' && player.onGround) {
                    player.velocityY = JUMP_VELOCITY;
                    player.isJumping = true;
                    player.onGround = false;
                }
            });
            document.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });
        }

        function handleMovement() {
            if (keys['KeyA'] || keys['KeyD']) {
                player.speedX = keys['KeyA'] ? -PLAYER_SPEED : PLAYER_SPEED;
            } else {
                player.speedX *= FRICTION;
            }
            
            player.x += player.speedX;
            player.velocityY += GRAVITY;
            player.y += player.velocityY;
            player.onGround = false; 
        }

        function checkCollision() {
            for (let p of platforms) {
                if (
                    player.x < p.x + p.width &&
                    player.x + player.width > p.x &&
                    player.y + player.height > p.y &&
                    player.y < p.y + p.height
                ) {
                    if (player.velocityY > 0 && player.y + player.height <= p.y + player.velocityY + 1) {
                        player.y = p.y - player.height;
                        player.velocityY = 0;
                        player.onGround = true;
                        player.isJumping = false;
                        
                        if (p.isGoal) {
                            levelComplete();
                            return;
                        }
                    }
                    else if (player.velocityY < 0) {
                        player.velocityY = 0;
                    }
                }
            }
        }

        function checkGameStatus() {
            if (player.y > canvas.height + 50) {
                gameOver();
                return;
            }
            
            if (player.x < platforms[0].x) {
                player.x = platforms[0].x;
            }
        }
        
        // --- MEN√ú-LOGIK ---

        // NEU: Zeichnet den Levelauswahl-Bildschirm
        function drawMenu() {
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('W√ÑHLE DEIN LEVEL', canvas.width / 2, 70);
            
            const btnWidth = 100;
            const btnHeight = 60;
            const startX = (canvas.width - (totalLevels * btnWidth + (totalLevels - 1) * 20)) / 2;
            
            // Definiere die Positionen der klickbaren Buttons
            const menuButtons = [];

            for (let i = 1; i <= totalLevels; i++) {
                const x = startX + (i - 1) * (btnWidth + 20);
                const y = canvas.height / 2 - btnHeight / 2;
                const isLocked = i > maxUnlockedLevel;

                menuButtons.push({ x, y, width: btnWidth, height: btnHeight, level: i, isLocked });

                ctx.fillStyle = isLocked ? '#7f8c8d' : '#2980b9'; // Grau, wenn gesperrt, Blau, wenn freigeschaltet
                ctx.fillRect(x, y, btnWidth, btnHeight);
                
                ctx.fillStyle = isLocked ? '#bdc3c7' : '#ecf0f1';
                ctx.font = '30px Arial';
                ctx.fillText(`Lvl ${i}`, x + btnWidth / 2, y + btnHeight / 2 + 10);
                
                if (isLocked) {
                    ctx.font = '16px Arial';
                    ctx.fillText('üîí', x + btnWidth / 2, y + btnHeight / 2 - 15);
                }
            }
            return menuButtons;
        }

        let currentMenuButtons = [];

        // NEU: Startet das Spiel aus dem Men√º
        function startLevel(level) {
            if (level <= maxUnlockedLevel) {
                currentLevel = level;
                gameState = 'running';
                startGame();
            }
        }

        // NEU: Pr√ºft, ob ein Klick einen Level-Button getroffen hat
        function handleMenuClick(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            for (const button of currentMenuButtons) {
                if (
                    mouseX >= button.x &&
                    mouseX <= button.x + button.width &&
                    mouseY >= button.y &&
                    mouseY <= button.y + button.height
                ) {
                    startLevel(button.level);
                    break;
                }
            }
        }
        
        // --- HAUPT-SPIELSTATUS-WECHSEL ---

        function gameOver() {
            clearInterval(gameLoopId);
            gameState = 'gameover';
            drawEndScreen('GAME OVER!', '#ff0000', 'Klicke, um zum Men√º zur√ºckzukehren');
        }

        function levelComplete() {
            clearInterval(gameLoopId);
            
            // NEU: Schaltet das n√§chste Level frei
            if (currentLevel === maxUnlockedLevel && currentLevel < totalLevels) {
                maxUnlockedLevel++;
            }

            if (currentLevel < totalLevels) {
                gameState = 'complete';
                drawEndScreen(`LEVEL ${currentLevel} GESCHAFFT!`, '#00ff00', `Klicke, um zum Men√º zur√ºckzukehren`);
            } else {
                gameState = 'finished';
                drawEndScreen('ALLE LEVEL GESCHAFFT!', '#00ff00', 'Klicke, um zum Men√º zur√ºckzukehren');
            }
        }
        
        // NEU: Allgemeine Funktion zum Zeichnen des Endbildschirms
        function drawEndScreen(title, color, message) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = color;
            ctx.font = '50px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, canvas.height / 2 - 20);
            ctx.font = '20px Arial';
            ctx.fillStyle = '#fff';
            ctx.fillText(message, canvas.width / 2, canvas.height / 2 + 20);
        }

        // NEU: Kehrt zum Men√º zur√ºck
        function returnToMenu(e) {
            if (e.button === 0 && gameState !== 'running') {
                 canvas.removeEventListener('mousedown', returnToMenu);
                 showMenu();
            }
        }

        // --- HAUPT-LOOP UND SPIEL-MANAGEMENT ---

        function gameLoop() {
            if (gameState === 'running') {
                handleMovement();
                checkCollision();
                checkGameStatus();
                draw();
            }
        }

        function draw() {
            // ... (Zeichenlogik unver√§ndert)
            ctx.fillStyle = '#3498db';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const offsetX = canvas.width / 2 - player.x;

            for (let p of platforms) {
                const screenX = p.x + offsetX;
                
                if (p.isGoal) {
                    ctx.fillStyle = p.color;
                    ctx.fillRect(screenX, p.y, p.width, p.height);
                    
                    ctx.font = '20px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.fillText('ZIEL', screenX + p.width / 2, p.y + p.height / 2 + 5);
                } else {
                    ctx.fillStyle = p.color;
                    ctx.fillRect(screenX, p.y, p.width, p.height);
                }
            }

            ctx.fillStyle = player.color;
            ctx.fillRect(canvas.width / 2 - player.width / 2, player.y, player.width, player.height);
            
            ctx.font = '14px Arial';
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'left';
            ctx.fillText(`X: ${player.x.toFixed(0)} | Y: ${player.y.toFixed(0)}`, 10, canvas.height - 10);
        }

        function startGame() {
            clearInterval(gameLoopId);
            generateLevel(currentLevel);
            setupControls();
            gameLoopId = setInterval(gameLoop, 1000 / 60); 
            // Entfernt den Men√º-Klick-Handler und f√ºgt den Endbildschirm-Klick-Handler hinzu
            canvas.removeEventListener('mousedown', handleMenuClick);
            canvas.addEventListener('mousedown', returnToMenu); 
        }

        function showMenu() {
            gameState = 'menu';
            clearInterval(gameLoopId);
            currentMenuButtons = drawMenu();
            document.getElementById('level-display').textContent = '‚Äî';
            // Registriere den Men√º-Klick-Handler
            canvas.removeEventListener('mousedown', returnToMenu);
            canvas.addEventListener('mousedown', handleMenuClick);
        }

        // --- INIT ---
        window.onload = showMenu;
        
    </script>
</body>
</html>